#include "vga.h"
#include "../hardware/io.h"
#include "keyboard.h"

vga_mode_t g_90x30_text = {
/* MISC */
	0xE7,
/* SEQ */
	0x03, 0x01, 0x03, 0x00, 0x02,
/* CRTC */
	0x6B, 0x59, 0x5A, 0x82, 0x60, 0x8D, 0x0B, 0x3E,
	0x00, 0x4F, 0x0D, 0x0E, 0x00, 0x00, 0x00, 0x00,
	0xEA, 0x0C, 0xDF, 0x2D, 0x10, 0xE8, 0x05, 0xA3,
	0xFF,
/* GC */
	0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x0E, 0x00,
	0xFF,
/* AC */
	0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x14, 0x07,
	0x38, 0x39, 0x3A, 0x3B, 0x3C, 0x3D, 0x3E, 0x3F,
	0x0C, 0x00, 0x0F, 0x08, 0x00,
/* DIMENSIONS */
	1, 90, 30, 0
};

vga_mode_t g_720x480x16 = {
/* MISC */
	0xE7,
/* SEQ */
	0x03, 0x01, 0x08, 0x00, 0x06,
/* CRTC */
	0x6B, 0x59, 0x5A, 0x82, 0x60, 0x8D, 0x0B, 0x3E,
	0x00, 0x40, 0x06, 0x07, 0x00, 0x00, 0x00, 0x00,
	0xEA, 0x0C, 0xDF, 0x2D, 0x08, 0xE8, 0x05, 0xE3,
	0xFF,
/* GC */
	0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x05, 0x0F,
	0xFF,
/* AC */
	0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07,
	0x08, 0x09, 0x0A, 0x0B, 0x0C, 0x0D, 0x0E, 0x0F,
	0x01, 0x00, 0x0F, 0x00, 0x00,
/* DIMENSIONS */
	0, 720, 840, 16
};

vga_mode_t g_80x25_text = {
/* MISC */
	0x67,
/* SEQ */
	0x03, 0x00, 0x03, 0x00, 0x02,
/* CRTC */
	0x5F, 0x4F, 0x50, 0x82, 0x55, 0x81, 0xBF, 0x1F,
	0x00, 0x4F, 0x0D, 0x0E, 0x00, 0x00, 0x00, 0x50,
	0x9C, 0x0E, 0x8F, 0x28, 0x1F, 0x96, 0xB9, 0xA3,
	0xFF,
/* GC */
	0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x0E, 0x00,
	0xFF,
/* AC */
	0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x14, 0x07,
	0x38, 0x39, 0x3A, 0x3B, 0x3C, 0x3D, 0x3E, 0x3F,
	0x0C, 0x00, 0x0F, 0x08, 0x00,
/* DIMENSIONS */
	1, 80, 25, 0
};

vga_mode_t g_320x200x4 = {
/* MISC */
	0x63,
/* SEQ */
	0x03, 0x09, 0x03, 0x00, 0x02,
/* CRTC */
	0x2D, 0x27, 0x28, 0x90, 0x2B, 0x80, 0xBF, 0x1F,
	0x00, 0x41, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x9C, 0x0E, 0x8F, 0x14, 0x00, 0x96, 0xB9, 0xA3,
	0xFF,
/* GC */
	0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0x02, 0x00,
	0xFF,
/* AC */
	0x00, 0x13, 0x15, 0x17, 0x02, 0x04, 0x06, 0x07,
	0x10, 0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17,
	0x01, 0x00, 0x03, 0x00, 0x00,
/* DIMENSIONS */
	0, 320, 200, 4
};

vga_mode_t current_vga_mode = { // g_80x25_text
/* MISC */
	0x67,
/* SEQ */
	0x03, 0x00, 0x03, 0x00, 0x02,
/* CRTC */
	0x5F, 0x4F, 0x50, 0x82, 0x55, 0x81, 0xBF, 0x1F,
	0x00, 0x4F, 0x0D, 0x0E, 0x00, 0x00, 0x00, 0x50,
	0x9C, 0x0E, 0x8F, 0x28, 0x1F, 0x96, 0xB9, 0xA3,
	0xFF,
/* GC */
	0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x0E, 0x00,
	0xFF,
/* AC */
	0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x14, 0x07,
	0x38, 0x39, 0x3A, 0x3B, 0x3C, 0x3D, 0x3E, 0x3F,
	0x0C, 0x00, 0x0F, 0x08, 0x00,
/* DIMENSIONS */
	1, 80, 25, 0
};

/*
current_vga_mode.width
current_vga_mode.height
*/

void write_pixel(u32 x, u32 y, u32 color){
	color = (color & 3) * 0x55;
	u32 wd_in_bytes = current_vga_mode.width / 4;
	u32 off = wd_in_bytes * y + x / 4;
	x = (x & 3) * 2;
	u32 mask = 0xC0 >> x;
	
	u8 * pixel = VGA_VIDEO_MEMORY + off;
	*pixel = (*pixel & ~mask) | (color & mask);
}

void switch_vga_mode(vga_mode_t mode){
	current_vga_mode = mode;
	u32 i;
	io_out_b(VGA_MISC_WRITE, mode.misc);
	
	for (i = 0; i < VGA_NUM_SEQ_REGS; i++){
		io_out_b(VGA_SEQ_INDEX, i);
		io_out_b(VGA_SEQ_DATA, mode.sequencer[i]);
	}
	
	io_out_b(VGA_CRTC_INDEX, 0x03);
	io_out_b(VGA_CRTC_DATA, io_in_b(VGA_CRTC_DATA) | 0x80);
	io_out_b(VGA_CRTC_INDEX, 0x11);
	io_out_b(VGA_CRTC_DATA, io_in_b(VGA_CRTC_DATA) & ~0x80);
	
	mode.crtc[0x03] |= 0x80;
	mode.crtc[0x11] &= ~0x80;
	
	for (i = 0; i < VGA_NUM_CRTC_REGS; i++){
		io_out_b(VGA_CRTC_INDEX, i);
		io_out_b(VGA_CRTC_DATA, mode.crtc[i]);
	}
	
	for (i = 0; i < VGA_NUM_GC_REGS; i++){
		io_out_b(VGA_GC_INDEX, i);
		io_out_b(VGA_GC_DATA, mode.graphics_controller[i]);
	}
	
	for (i = 0; i < VGA_NUM_AC_REGS; i++){
		io_in_b(VGA_INSTAT_READ);
		io_out_b(VGA_AC_INDEX, i);
		io_out_b(VGA_AC_WRITE, mode.attr_controller[i]);
	}
	io_in_b(VGA_INSTAT_READ);
	io_out_b(VGA_AC_INDEX, 0x20);
}

void vga_text_big(){
	switch_vga_mode(g_90x30_text);
}

u32 i = 0;
u32 khid;

bool vga_kbcb(keyboard_packet_t packet){
	if (packet.value == 27){
		remove_keyboard_handler(khid, false);
		vga_text_big();
		clear_screen();
		console();
	} else mset(VGA_VIDEO_MEMORY, 0xff, i++);
	return true;
}

void vga_test(){
	//switch_vga_mode(g_90x30_text);
	switch_vga_mode(g_720x480x16);
	//khid = register_keyboard_handler(&vga_kbcb, false);
	mset(VGA_VIDEO_MEMORY, 0xff, 720 * 480);
	while (1);
}


















